 # .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

# Variables (customize as needed)
variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: scriptdojo
  SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3307/scriptdojo?useSSL=false&serverTimezone=UTC

# Build Backend (Spring Boot with Maven)
build-backend:
  stage: build
  image: maven:3.9.11-openjdk-17
  script:
    - cd backend
    - mvn clean install -DskipTests
  cache:
    paths:
      - backend/.m2/
  artifacts:
    paths:
      - backend/target/*.jar
  tags:
    - docker

# Build Frontend (React with Vite)
build-frontend:
  stage: build
  image: node:22
  script:
    - cd frontend
    - npm install
    - npm run build
  cache:
    paths:
      - frontend/node_modules/
  artifacts:
    paths:
      - frontend/dist/
  tags:
    - docker

# Test Backend (JUnit)
test-backend:
  stage: test
  image: maven:3.9.11-openjdk-17
  script:
    - cd backend
    - mvn test
  dependencies:
    - build-backend
  artifacts:
    paths:
      - backend/target/surefire-reports/
  tags:
    - docker

# Test Frontend (Playwright)
test-frontend:
  stage: test
  image: mcr.microsoft.com/playwright:v1.45.0-jammy
  script:
    - cd frontend
    - npm install
    - npx playwright install
    - npx playwright test
  dependencies:
    - build-frontend
  artifacts:
    paths:
      - frontend/test-results/
  tags:
    - docker


# Optional: Setup MySQL (if not handled by Docker Compose)
setup-db:
  stage: deploy
  image: mysql:8
  script:
    - mysql -h mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS scriptdojo;"
    - mysql -h mysql -u root -proot scriptdojo < backend/src/main/resources/schema.sql
  variables:
    MYSQL_HOST: mysql
    MYSQL_ROOT_PASSWORD: $MYSQL_ROOT_PASSWORD
  tags:
    - docker
