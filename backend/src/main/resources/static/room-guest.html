<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ScriptDojo â€¢ Live Share (Guest)</title>
    <style>
        body, html {
            margin:0;
            padding:0;
            height:100%;
            background:#1e1e1e;
            font-family: system-ui;
            overflow:hidden;
        }
        #container {
            display:flex;
            height:100%;
        }
        #editor {
            flex:1;
        }
        #sidebar {
            width:300px;
            background:#252526;
            color:#ccc;
            padding:20px;
            box-sizing:border-box;
            overflow-y: auto;
        }
        h2 {
            color:#0f0;
            margin-top: 0;
        }
        button {
            background:#0f0;
            color:black;
            padding:12px;
            border:none;
            width:100%;
            font-weight:bold;
            margin-top:10px;
            border-radius:6px;
            cursor:pointer;
        }
        button:hover {
            background:#0c0;
        }
        #status {
            margin-top:20px;
            font-size:1.1em;
            color:#ff0;
        }
        .info {
            background:#333;
            padding:10px;
            border-radius:6px;
            margin:10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-connected {
            background: #0f0;
        }
        .status-disconnected {
            background: #f44;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="editor"></div>
    <div id="sidebar">
        <h2>
            <span id="connectionStatus" class="status-indicator status-disconnected"></span>
            ScriptDojo Live
        </h2>
        <div class="info">
            <strong>File:</strong> <span id="fileName">Loading...</span>
        </div>
        <div class="info">
            <strong>Guest:</strong> <span id="guestName">...</span>
        </div>
        <div id="status">ğŸ”’ View-only mode</div>
        <button onclick="sayHello()">Say I'm Here ğŸ‘‹</button>
        <div id="users" style="margin-top:20px; color:#888;">Connecting...</div>
    </div>
</div>

<!-- ========================================
     LOAD LIBRARIES FIRST - CRITICAL ORDER
     ======================================== -->

<!-- 1. SockJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>

<!-- 2. STOMP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- 3. Monaco Loader -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>

<!-- 4. Application Code -->
<script>
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // READ DATA FROM URL
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    const params = new URLSearchParams(window.location.search);
    const fileId = Number(params.get('fileId'));
    const roomId = params.get('roomId');
    const fileName = decodeURIComponent(params.get('fileName') || 'Unknown.java');
    const encodedContent = params.get('content');

    console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log("ğŸ‘¤ GUEST SESSION STARTING");
    console.log("   Room ID:", roomId);
    console.log("   File ID:", fileId);
    console.log("   File Name:", fileName);
    console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    // Decode Base64 content
    let content = '';
    if (encodedContent) {
        try {
            content = atob(encodedContent);
            console.log("âœ… Content decoded:", content.length, "characters");
            console.log("   First 100 chars:", content.substring(0, Math.min(100, content.length)));
        } catch (e) {
            console.error("âŒ Base64 decode failed:", e);
            content = '// Failed to load shared content';
        }
    } else {
        console.warn("âš ï¸ No content in URL");
        content = '// Shared file is empty';
    }

    if (!fileId || !roomId) {
        document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:50%'>âŒ Invalid share link</h1>";
        throw new Error("Missing fileId or roomId");
    }

    document.getElementById('fileName').textContent = fileName;

    // SAY HELLO FUNCTION
    function sayHello() {
        const guestName = document.getElementById('guestName').textContent;
        alert("Hi! I'm " + guestName + " ğŸ‘‹\n\nWaiting for the host to grant edit permission...");
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // MONACO EDITOR
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs' }});
    require(['vs/editor/editor.main'], () => {
        const editor = monaco.editor.create(document.getElementById('editor'), {
            value: content,
            language: 'java',
            theme: 'vs-dark',
            readOnly: true,  // Start as read-only
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
            fontSize: 16
        });

        console.log("âœ… Monaco Editor created (read-only)");

        const guestName = "Guest" + Math.floor(Math.random() * 9999);
        document.getElementById('guestName').textContent = guestName;
        console.log("ğŸ‘¤ Guest username:", guestName);

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // WEBSOCKET CONNECTION
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        console.log("ğŸ”Œ Guest connecting to WebSocket...");

        const socket = new SockJS('/ws');
        const client = Stomp.over(socket);

        // Enable debug
        client.debug = function(str) {
            console.log('ğŸ”§ STOMP Debug:', str);
        };

        let isConnected = false;

        client.connect({}, (frame) => {
            isConnected = true;

            console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            console.log("âœ… GUEST WEBSOCKET CONNECTED");
            console.log("   Session:", frame.headers['session']);
            console.log("   Room:", roomId);
            console.log("   File:", fileId);
            console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
            document.getElementById('users').innerHTML = '<span style="color:#0f0">âœ“ ' + guestName + ' connected</span>';

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SUBSCRIBE TO TEXT CHANGES (SAME AS HOST!)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            const textSubscription = client.subscribe('/topic/room/' + fileId, msg => {
                console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                console.log("ğŸ“¥ GUEST RECEIVED TEXT UPDATE");
                console.log("   Topic: /topic/room/" + fileId);

                try {
                    const change = JSON.parse(msg.body);
                    console.log("   Content length:", change.content.length);
                    console.log("   First 100 chars:", change.content.substring(0, Math.min(100, change.content.length)));

                    const currentContent = editor.getValue();

                    if (currentContent !== change.content) {
                        console.log("âœï¸ UPDATING GUEST EDITOR");
                        const position = editor.getPosition();
                        editor.setValue(change.content);
                        if (position) {
                            editor.setPosition(position);
                            console.log("   Cursor restored to", position.lineNumber + ":" + position.column);
                        }
                    } else {
                        console.log("â­ï¸ SKIPPING (content identical)");
                    }
                } catch (e) {
                    console.error("âŒ Failed to parse message:", e);
                }

                console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            });

            console.log("ğŸ“» Guest subscribed to: /topic/room/" + fileId);
            console.log("   Subscription ID:", textSubscription.id);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SUBSCRIBE TO PERMISSION CHANGES
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            client.subscribe('/topic/room/' + roomId + '/permissions', msg => {
                console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                console.log("ğŸ”“ PERMISSION UPDATE RECEIVED");

                try {
                    const perm = JSON.parse(msg.body);
                    console.log("   Permission:", perm);

                    if (perm.username === guestName && perm.canEdit) {
                        console.log("âœ… EDIT PERMISSION GRANTED!");

                        editor.updateOptions({ readOnly: false });
                        document.getElementById('status').innerHTML = "<span style='color:#0f0; font-weight:bold;'>âœ“ You can now EDIT!</span>";

                        // Enable sending edits
                        let typingTimer;
                        let lastSentContent = editor.getValue();

                        editor.onDidChangeModelContent(() => {
                            clearTimeout(typingTimer);
                            typingTimer = setTimeout(() => {
                                const content = editor.getValue();

                                if (content !== lastSentContent) {
                                    console.log("ğŸ“¤ Guest sending update");
                                    client.send('/app/room/' + fileId + '/edit', {}, JSON.stringify({ content }));
                                    lastSentContent = content;
                                }
                            }, 300);
                        });
                    }
                } catch (e) {
                    console.error("âŒ Failed to parse permission:", e);
                }

                console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            });

            console.log("ğŸ“» Guest subscribed to: /topic/room/" + roomId + "/permissions");

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SUBSCRIBE TO CURSORS
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            client.subscribe('/topic/room/' + fileId + '/cursors', msg => {
                try {
                    const cursor = JSON.parse(msg.body);
                    console.log("ğŸ‘† Cursor:", cursor.username, "at", cursor.line + ":" + cursor.column);
                } catch (e) {
console.error("âŒ Failed to parse cursor:", e);
}
});
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // SEND OWN CURSOR
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        editor.onDidChangeCursorPosition(e => {
            if (isConnected) {
                try {
                    client.send('/app/room/' + fileId + '/cursor', {}, JSON.stringify({
                        username: guestName,
                        line: e.position.lineNumber,
                        column: e.position.column
                    }));
                } catch (err) {
                    console.error("âŒ Failed to send cursor:", err);
                }
            }
        });

        console.log("âœ… Guest event listeners attached");

    }, (error) => {
        isConnected = false;

        console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        console.error("âŒ GUEST WEBSOCKET FAILED");
        console.error("   Error:", error);
        console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
        document.getElementById('users').innerHTML = "<span style='color:red'>âŒ Connection failed</span>";
    });
});
</script>
</body>
</html>
