<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ScriptDojo - Real-time Java Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #1e1e1e;
            color: #ddd;
            font-family: 'Segoe UI', sans-serif;
        }
        #container {
            display: flex;
            height: 100vh;
        }
        #editor {
            flex: 1;
        }
        #sidebar {
            width: 300px;
            background: #252526;
            padding: 15px;
            overflow-y: auto;
            border-left: 1px solid #444;
        }
        h2 {
            margin: 0 0 15px 0;
            color: #0f0;
            font-size: 1.4em;
        }
        .user {
            padding: 8px;
            background: #333;
            margin: 6px 0;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .cursor {
            color: #0ff;
            font-weight: bold;
        }
        #output {
            background: #000;
            color: #0f0;
            padding: 12px;
            margin-top: 15px;
            height: 180px;
            overflow-y: auto;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #0f0;
            color: black;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
        }
        button:hover {
            background: #0c0;
        }
        .header {
            background: #007acc;
            color: white;
            padding: 10px 15px;
            font-size: 1.1em;
        }
        .filename {
            font-weight: bold;
        }
        .back {
            float: right;
            color: #aaa;
            text-decoration: none;
        }
        .back:hover {
            text-decoration: underline;
        }
        #shareSection {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #0f0;
            max-width: 400px;
        }
        #shareSection button {
            margin: 0;
        }
        #shareLink {
            margin-top: 10px;
            color: #0ff;
            word-break: break-all;
            font-size: 0.9em;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-connected {
            background: #0f0;
        }
        .status-disconnected {
            background: #f44;
        }
        .user-item {
            padding: 10px;
            background: #333;
            margin: 8px 0;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .user-name {
            color: #0ff;
            font-weight: bold;
        }
        .user-role {
            color: #888;
            font-size: 0.85em;
            margin-left: 5px;
        }
        .grant-btn {
            background: #0f0;
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 5px;
            width: 100%;
        }
        .grant-btn:hover {
            background: #0c0;
        }
        .revoke-btn {
            background: #f44;
            color: white;
        }
        .revoke-btn:hover {
            background: #c33;
        }
        .permission-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        .badge-view {
            background: #666;
            color: white;
        }
        .badge-edit {
            background: #0f0;
            color: black;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="editor"></div>
    <div id="sidebar">
        <div class="header">
            <span id="filename">Loading...</span>
            <a href="/dashboard.html" class="back">Back to Files</a>
        </div>

        <h2>
            <span id="connectionStatus" class="status-indicator status-disconnected"></span>
            Online Users
        </h2>

        <!-- Online Users List -->
        <div id="users">
            <em>âœ… Connected as <strong id="hostUsername">...</strong> (Host)</em>
        </div>

        <hr style="border: 1px solid #444; margin: 15px 0;">

        <button onclick="runCode()">Run Java Code</button>
        <pre id="output">Click "Run Java Code" to execute (not implemented yet)</pre>
    </div>
</div>

<!-- Share Link Section -->
<div id="shareSection">
    <button onclick="generateShareLink()">Generate Share Link</button>
    <div id="shareLink"></div>
</div>

<!-- ========================================
     LOAD LIBRARIES FIRST - CRITICAL ORDER
     ======================================== -->

<!-- 1. SockJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>

<!-- 2. STOMP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- 3. Monaco Loader -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>

<!-- 4. Application Code -->
<script>
    // GENERATE SHARE LINK
    async function generateShareLink() {
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('fileId');
        if (!fileId) return alert("No file open!");

        const response = await fetch('/api/room/create?fileId=' + fileId, {
            method: 'POST',
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('shareLink').innerHTML = `
                <strong>Share this link:</strong><br>
                <a href="${data.url}" target="_blank" style="color:#0ff;">${data.url}</a>
            `;
        } else {
            alert("Failed to generate link");
        }
    }

    // RUN CODE (placeholder)
    function runCode() {
        const output = document.getElementById('output');
        output.style.color = "#ff0";
        output.textContent = "âš ï¸ Java compiler not implemented yet (Feature #5 coming soon)";
    }

    // MONACO EDITOR + WEBSOCKET
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs' }});
    require(['vs/editor/editor.main'], async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('fileId');

        if (!fileId) {
            document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:100px;'>No file selected</h1>";
            return;
        }

        console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        console.log("ğŸš€ EDITOR INITIALIZING");
        console.log("   File ID:", fileId);
        console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        // LOAD FILE FROM SERVER
        let file = { name: "Loading...", content: "" };
        try {
            const res = await fetch(`/api/files/${fileId}`, { credentials: 'include' });
            if (res.ok) {
                file = await res.json();
                console.log("âœ… File loaded:", file.name, "(" + file.content.length + " chars)");
            } else {
                console.error("âŒ File load failed:", res.status);
            }
        } catch (e) {
            console.error("âŒ Failed to load file:", e);
        }

        // SET FILENAME
        document.getElementById('filename').textContent = file.name || "Untitled.java";

        // CREATE MONACO EDITOR
        const editor = monaco.editor.create(document.getElementById('editor'), {
            value: file.content || "// Empty file",
            language: 'java',
            theme: 'vs-dark',
            fontSize: 16,
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: false
        });

        console.log("âœ… Monaco Editor created");

        // GET CURRENT USER
        let username = "Host";
        try {
            const userRes = await fetch('/api/user/me', { credentials: 'include' });
            if (userRes.ok) {
                const userData = await userRes.json();
                username = userData.username;
                console.log("ğŸ‘¤ Logged in as:", username);
            }
        } catch (e) {
            console.warn("âš ï¸ Could not fetch username:", e);
        }

        // WEBSOCKET CONNECTION
        console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        console.log("ğŸ”Œ Initializing WebSocket...");

        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        // Enable debug for troubleshooting
        stompClient.debug = function(str) {
            console.log('ğŸ”§ STOMP Debug:', str);
        };

        let isConnected = false;

        stompClient.connect({}, function (frame) {
            isConnected = true;

            console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            console.log("âœ… WEBSOCKET CONNECTED");
            console.log("   Session:", frame.headers['session']);
            console.log("   User:", username);
            console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            // Update UI
            document.getElementById('connectionStatus').className = 'status-indicator status-connected';
            document.getElementById('hostUsername').textContent = username;

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SUBSCRIBE TO TEXT CHANGES
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            const textSubscription = stompClient.subscribe('/topic/room/' + fileId, function (message) {
                console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                console.log("ğŸ“¥ TEXT UPDATE RECEIVED");
                console.log("   Topic: /topic/room/" + fileId);

                try {
                    const change = JSON.parse(message.body);
                    console.log("   Content length:", change.content.length);
                    console.log("   First 100 chars:", change.content.substring(0, Math.min(100, change.content.length)));

                    const currentContent = editor.getValue();

                    if (currentContent !== change.content) {
                        console.log("âœï¸ UPDATING EDITOR (content differs)");
                        const position = editor.getPosition();
                        editor.setValue(change.content);
                        if (position) {
                            editor.setPosition(position);
                            console.log("   Cursor restored to", position.lineNumber + ":" + position.column);
                        }
                    } else {
                        console.log("â­ï¸ SKIPPING UPDATE (content identical - avoiding loop)");
                    }
                } catch (e) {
                    console.error("âŒ Failed to parse message:", e);
                }

                console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            });

            console.log("ğŸ“» Subscribed to: /topic/room/" + fileId);
            console.log("   Subscription ID:", textSubscription.id);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SUBSCRIBE TO CURSOR UPDATES
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            const cursorSubscription = stompClient.subscribe('/topic/room/' + fileId + '/cursors', function (message) {
                try {
                    const cursor = JSON.parse(message.body);
                    console.log("ğŸ‘† Cursor update:", cursor.username, "at", cursor.line + ":" + cursor.column);
                    updateUserList(cursor);
                } catch (e) {
                    console.error("âŒ Failed to parse cursor message:", e);
                }
            });

            console.log("ğŸ“» Subscribed to: /topic/room/" + fileId + "/cursors");
            console.log("   Subscription ID:", cursorSubscription.id);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SUBSCRIBE TO ACTIVE USERS
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            const usersSubscription = stompClient.subscribe('/topic/room/' + fileId + '/users', function (message) {
                try {
                    const data = JSON.parse(message.body);
                    console.log("ğŸ‘¥ Active users update:", data);
                    updateUsersList(data.users);
                } catch (e) {
                    console.error("âŒ Failed to parse users message:", e);
                }
            });

            console.log("ğŸ“» Subscribed to: /topic/room/" + fileId + "/users");
            console.log("   Subscription ID:", usersSubscription.id);

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SEND TEXT CHANGES (DEBOUNCED)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            let typingTimer;
            let lastSentContent = editor.getValue();

            editor.onDidChangeModelContent(() => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    const content = editor.getValue();

                    // Only send if content actually changed
                    if (content !== lastSentContent) {
                        console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                        console.log("ğŸ“¤ SENDING TEXT UPDATE");
                        console.log("   Destination: /app/room/" + fileId + "/edit");
                        console.log("   Content length:", content.length);
                        console.log("   First 100 chars:", content.substring(0, Math.min(100, content.length)));

                        try {
                            stompClient.send(
                                '/app/room/' + fileId + '/edit',
                                {},
                                JSON.stringify({ content: content })
                            );
                            lastSentContent = content;
                            console.log("âœ… Update sent successfully");
                        } catch (e) {
                            console.error("âŒ Failed to send update:", e);
                        }

                        console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                    }
                }, 300); // 300ms debounce
            });

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // SEND CURSOR POSITION
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            editor.onDidChangeCursorPosition(e => {
                if (isConnected) {
                    try {
                        stompClient.send(
                            '/app/room/' + fileId + '/cursor',
                            {},
                            JSON.stringify({
                                username: username,
                                line: e.position.lineNumber,
                                column: e.position.column
                            })
                        );
                    } catch (err) {
                        console.error("âŒ Failed to send cursor:", err);
                    }
                }
            });

            console.log("âœ… Event listeners attached");

        }, function (error) {
            isConnected = false;

            console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            console.error("âŒ WEBSOCKET CONNECTION FAILED");
            console.error("   Error:", error);
            console.error("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

            document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // HELPER FUNCTIONS
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        function updateUserList(cursor) {
            // Legacy cursor tracking - keeping for backwards compatibility
            console.log("Cursor position tracked:", cursor);
        }

        function updateUsersList(users) {
            const usersDiv = document.getElementById('users');

            // Clear existing (except host indicator)
            usersDiv.innerHTML = `<em>âœ… Connected as <strong>${username}</strong> (Host)</em>`;

            // Filter out the host from the list
            const guests = Array.from(users).filter(u => u !== username);

            if (guests.length === 0) {
                const noGuests = document.createElement('div');
                noGuests.style.color = '#888';
                noGuests.style.marginTop = '10px';
                noGuests.innerHTML = '<em>No guests connected yet</em>';
                usersDiv.appendChild(noGuests);
                return;
            }

            // Show each guest
            guests.forEach(guestName => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.setAttribute('data-guest', guestName);

                userDiv.innerHTML = `
                    <div>
                        <span class="user-name">ğŸ‘¤ ${guestName}</span>
                        <span class="permission-badge badge-view" id="badge-${guestName}">VIEW</span>
                    </div>
                    <button class="grant-btn" onclick="grantEdit('${guestName}')">
                        Grant Edit Permission
                    </button>
                `;

                usersDiv.appendChild(userDiv);
            });

            console.log("âœ… Updated users list:", guests);
        }
    });

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // GRANT EDIT PERMISSION
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    async function grantEdit(guestName) {
        console.log("ğŸ”“ Granting edit permission to:", guestName);

        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('fileId');

        try {
            const response = await fetch('/api/permissions/grant-edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'include',
                body: new URLSearchParams({
                    fileId: fileId,
                    guestName: guestName
                })
            });

            if (response.ok) {
                console.log("âœ… Permission granted successfully");

                // Update UI
                const badge = document.getElementById('badge-' + guestName);
                if (badge) {
                    badge.textContent = 'EDIT';
                    badge.className = 'permission-badge badge-edit';
                }

                // Change button to revoke
                const userDiv = document.querySelector(`[data-guest="${guestName}"]`);
                if (userDiv) {
                    const btn = userDiv.querySelector('button');
                    btn.textContent = 'Revoke Edit Permission';
                    btn.className = 'grant-btn revoke-btn';
                    btn.onclick = () => revokeEdit(guestName);
                }

                alert(`âœ… ${guestName} can now edit the file!`);
            } else {
                console.error("âŒ Failed to grant permission:", response.status);
                alert("Failed to grant permission");
            }
        } catch (error) {
            console.error("âŒ Error granting permission:", error);
            alert("Error granting permission");
        }
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // REVOKE EDIT PERMISSION
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    async function revokeEdit(guestName) {
        console.log("ğŸ”’ Revoking edit permission from:", guestName);

        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('fileId');

        try {
            const response = await fetch('/api/permissions/revoke-edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'include',
                body: new URLSearchParams({
                    fileId: fileId,
                    guestName: guestName
                })
            });

            if (response.ok) {
                console.log("âœ… Permission revoked successfully");

                // Update UI
                const badge = document.getElementById('badge-' + guestName);
                if (badge) {
                    badge.textContent = 'VIEW';
                    badge.className = 'permission-badge badge-view';
                }

                // Change button back to grant
                const userDiv = document.querySelector(`[data-guest="${guestName}"]`);
                if (userDiv) {
                    const btn = userDiv.querySelector('button');
                    btn.textContent = 'Grant Edit Permission';
                    btn.className = 'grant-btn';
                    btn.onclick = () => grantEdit(guestName);
                }

                alert(`ğŸ”’ ${guestName} is now view-only`);
            } else {
                console.error("âŒ Failed to revoke permission:", response.status);
                alert("Failed to revoke permission");
            }
        } catch (error) {
            console.error("âŒ Error revoking permission:", error);
            alert("Error revoking permission");
        }
    }
</script>
</body>
</html>